---
- name: "check if {{ disk_dev }} exists"
  stat: "path={{ disk_dev }}"
  register: disk

- fail:
    msg: "{{ disk_dev }} isn't defined (path doesn't exist)"
  when: not disk.stat.exists

- name: "Unmount {{ disk_dev }} partitions if existing"
  command: "umount -fl {{ item.mount }}"
  with_items:
    - "{{ ansible_mounts }}"
  when: "disk_dev in item.device or '/dev/mapper/cryptroot' in item.device"
  become: yes
  ignore_errors: yes

- name: "Zeroize {{ disk_dev }}"
  command: "blkdiscard {{ disk_dev }}"
  become: yes

- name: "Partitioning {{ disk_dev }}"
  command: "{{ item }}"
  with_items:
    - "sgdisk -Z {{ disk_dev }}"
    - "partprobe {{ disk_dev }}"
    - "parted -s {{ disk_dev }} mklabel gpt"
    - "parted -s {{ disk_dev }} mkpart primary fat32 1MiB 513MiB"
    - "parted -s {{ disk_dev }} mkpart primary btrfs 513MiB 100%"
    - "parted -s {{ disk_dev }} set 1 boot on"
  register: partition
  become: yes

- name: "Fail if return code is not 0"
  fail:
    msg: "The command ({{ item.cmd }}) did not have a 0 return code"
  when: item.rc != 0
  with_items: "{{partition.results}}"

- name: "Formate boot partition"
  command: "mkfs.fat -F32 -n EFI {{ disk_dev }}1"

- name: "wipefs{{ disk_dev }}2"
  command: "wipefs --all {{ disk_dev }}2"
  become: true

- name: "Encrypt root partition"
  shell: printf {{ root_password }} |cryptsetup luksFormat {{ disk_dev }}2 -
  become: yes

- name: "Open encrypted partition"
  shell: 'echo -n {{ root_password }} |cryptsetup open --type luks {{ disk_dev }}2 cryptroot --allow-discards -d -'
  become: yes

- name: "Formate system partition"
  filesystem:
    fstype: btrfs
    opts: "-L System -f"
    dev : "/dev/mapper/cryptroot"
